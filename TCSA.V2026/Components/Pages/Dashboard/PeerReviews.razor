@page "/dashboard/reviews"
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using TCSA.V2026.Data.Curriculum
@using TCSA.V2026.Data.DTOs
@using TCSA.V2026.Data.Models
@using TCSA.V2026.Data.Models.Responses
@using TCSA.V2026.Components.UI
@using TCSA.V2026.Helpers
@using TCSA.V2026.Services
@attribute [Authorize]

<PageTitle>Peer Reviews</PageTitle>

<MudContainer Class="pa-0">
    <DashboardToolBar></DashboardToolBar>

    @if (IsLoading)
    {
        <MudProgressCircular Color="Color.Default" Indeterminate="true" />
    }
    else
    {
        <MudText>LoadTime: @LoadTime.TotalSeconds.ToString()</MudText>
        if (AvailableProjects != null && AvailableProjects.Count > 0)
        {
            <MudStack Spacing="4">
                @foreach (var project in AvailableProjects)
                {
                    <MudPaper Elevation="3" Outlined="false" Class="py-3 px-4 px-md-5">
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Breakpoint="Breakpoint.Xs">
                            <MudStack Row Spacing="5">
                                <MudImage ObjectFit="ObjectFit.Contain" Width="60" Src="@($"img/icons/{project.IconUrl}")" Alt="..." />
                                <MudStack Spacing="0">
                                    <MudText Style="@($"font-weight:bolder; color:{Colors.DeepPurple.Lighten1}")" Typo="Typo.subtitle1">@project.Title</MudText>
                                    <MudText Typo="Typo.subtitle2">@project.Name</MudText>
                                    <MudText Style="@(project.DurationOpen.TotalDays > 7 ? "color: red" : "")" Class="mt-2" Typo="Typo.caption">
                                        @TimeSpanFormatter.FormatDurationOpen(project.DurationOpen)
                                    </MudText>
                                </MudStack>
                                <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                                    <MudText Style="font-weight:bolder" Typo="Typo.subtitle1">Reward:</MudText>
                                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                        <MudImage ObjectFit="ObjectFit.Contain" Width="30" Src="img/experience.png" />
                                        <MudText Style="font-weight:bolder" Typo="Typo.subtitle1">@project.ExperiencePoints</MudText>
                                    </MudStack>
                                </MudStack>
                            </MudStack>
                            <MudStack Row>
                                @if (!project.IsAssigned)
                                {
                                    <MudButton Size="@Size.Small"
                                               Variant="@Variant.Filled"
                                               Color="@Color.Primary"
                                               OnClick="@(() => AssignMyself(project.DashboardProjectId))"
                                               StartIcon="fas fa-hand-point-up">
                                        Pick
                                    </MudButton>
                                }
                                else
                                {
                                    <MudButton Size="@Size.Small"
                                               Variant="@Variant.Filled"
                                               Color="@Color.Error"
                                               OnClick="@(() => ReleaseMyself(project.DashboardProjectId))"
                                               StartIcon="@Icons.Material.Filled.Close">
                                        Drop
                                    </MudButton>
                                    <MudButton Size="@Size.Small"
                                               Variant="@Variant.Filled"
                                               Color="@Color.Success"
                                               OnClick="@(() => MarkAsComplete(project.DashboardProjectId, project.AppUserId))"
                                               StartIcon="@Icons.Material.Filled.ThumbUp">
                                        Tick
                                    </MudButton>
                                }
                                <MudButton Size="@Size.Small"
                                           Variant="@Variant.Filled"
                                           Color="@Color.Warning"
                                           OnClick="@(() => JS.InvokeVoidAsync("window.open", project.GithubUrl, "_blank", "noopener,noreferrer"))"
                                           StartIcon="fas fa-eye">
                                    View
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                }
            </MudStack>
        }
    }
</MudContainer>

@code {
    [Inject] private NavigationManager Navigation { get; set; }
    [Inject] private AuthenticationStateProvider AuthenticationState { get; set; }
    [Inject] private IProjectService ProjectService { get; set; }
    [Inject] private IUserService UserService { get; set; }
    [Inject] private IPeerReviewService PeerReviewService { get; set; }
    [Inject] private ISnackbar Snackbar { get; set; }
    [Inject] private IJSRuntime JS { get; set; }

    private List<Project>? projects;
    private List<PeerReviewDisplay> AvailableProjects;
    private ApplicationUser User;

    private bool IsLoading = true;
    private string UserId = string.Empty;
    private TimeSpan LoadTime;

    protected override async Task OnInitializedAsync()
    {
        var startTime = DateTime.UtcNow;
        var authSate = await AuthenticationState.GetAuthenticationStateAsync();

        if (!authSate.User.Identity.IsAuthenticated)
        {
            Navigation.NavigateTo("Account/Login");
        }

        var claims = authSate.User;
        UserId = claims.FindFirstValue(ClaimTypes.NameIdentifier);

        AvailableProjects = await PeerReviewService.GetProjectsForPeerReview(UserId);
        LoadTime = DateTime.UtcNow - startTime;

        IsLoading = false;
    }

    private async Task AssignMyself(int dashboardProjectId)
    {
        var result = await PeerReviewService.AssignUserToCodeReview(UserId, dashboardProjectId);

        if (result.Status == ResponseStatus.Success)
        {
            Snackbar.Add("Assignment Successful", Severity.Success);
            User = await UserService.GetUserById(UserId);
        }
        else
        {
            Snackbar.Add($"Error: {result.Message}", Severity.Error);
        }

        AvailableProjects = await PeerReviewService.GetProjectsForPeerReview(UserId);
    }

    private async Task ReleaseMyself(int dashboardProjectId)
    {
        var result = await PeerReviewService.ReleaseUserFromCodeReview(UserId, dashboardProjectId);

        if (result.Status == ResponseStatus.Success)
        {
            Snackbar.Add("Release successful", Severity.Success);
            User = await UserService.GetUserById(UserId);
        }
        else
        {
            Snackbar.Add($"Error: {result.Message}", Severity.Error);
        }

        AvailableProjects = await PeerReviewService.GetProjectsForPeerReview(UserId);
    }

    private async Task MarkAsComplete(int dashboardProjectId, string reviewerId)
    {
        var result = await PeerReviewService.MarkCodeReviewAsCompleted(UserId, dashboardProjectId, reviewerId);

        if (result.Status == ResponseStatus.Success)
        {
            Snackbar.Add("Successfully marked as complete", Severity.Success);
            User = await UserService.GetUserById(UserId);
        }
        else
        {
            Snackbar.Add($"Error: {result.Message}", Severity.Error);
        }

        AvailableProjects = await PeerReviewService.GetProjectsForPeerReview(UserId);
    }
}
